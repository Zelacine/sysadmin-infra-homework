---
- name: Ensure Nginx Container Exists
  community.docker.docker_container_info:
    name: "{{ web_nginx_container_name }}"
  register: web_nginx_info

- name: Ensure PHP-FPM Container Exists
  community.docker.docker_container_info:
    name: "{{ web_php_fpm_container_name }}"
  register: web_php_info

- name: Fail if required containers are missing
  ansible.builtin.fail:
    msg: >-
      One or more containers ({{ web_nginx_container_name }}, {{ web_php_fpm_container_name }}) were
      not found. Make sure Terraform has created them.
  when: not (web_nginx_info.exists and web_php_info.exists)

- name: Ensure temporary render directory exists
  ansible.builtin.file:
    path: "{{ web_temp_render_dir }}"
    state: directory
    mode: "0700"

- name: Deploy nginx configuration on host
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: "{{ web_nginx_conf_host_path }}"
    mode: "0644"
  register: web_rendered_nginx
  notify: Restart Nginx Container

- name: Render application index locally
  ansible.builtin.template:
    src: index.php.j2
    dest: "{{ web_temp_render_dir }}/index.php"
    mode: "0600"
  register: web_rendered_index

- name: Render logrotate configuration locally
  ansible.builtin.template:
    src: logrotate-nginx.j2
    dest: "{{ web_temp_render_dir }}/logrotate-nginx"
    mode: "0600"
  register: web_rendered_logrotate

- name: Ensure php web root exists in container
  community.docker.docker_container_exec:
    container: "{{ web_php_fpm_container_name }}"
    command: "mkdir -p {{ web_php_web_root }}"
  changed_when: false

- name: Copy logrotate configuration into container staging path
  ansible.builtin.command:
    cmd: >
      docker cp {{ web_temp_render_dir }}/logrotate-nginx
      {{ web_nginx_container_name }}:{{ web_logrotate_temp_path }}
  when: web_rendered_logrotate is defined
  changed_when: web_rendered_logrotate is changed

- name: Move logrotate configuration into place
  community.docker.docker_container_exec:
    container: "{{ web_nginx_container_name }}"
    command: >
      sh -c "cat {{ web_logrotate_temp_path }} > {{ web_logrotate_path }}
      && rm -f {{ web_logrotate_temp_path }}"
  when: web_rendered_logrotate is defined
  changed_when: web_rendered_logrotate is changed
  notify: Restart Nginx Container

- name: Copy application index.php into php-fpm container staging path
  ansible.builtin.command:
    cmd: >
      docker cp {{ web_temp_render_dir }}/index.php
      {{ web_php_fpm_container_name }}:{{ web_php_temp_index_path }}
  when: web_rendered_index is defined
  changed_when: web_rendered_index is changed

- name: Move application index.php into place
  community.docker.docker_container_exec:
    container: "{{ web_php_fpm_container_name }}"
    command: >
      sh -c "cat {{ web_php_temp_index_path }} > {{ web_php_web_root }}/index.php
      && rm -f {{ web_php_temp_index_path }}"
  when: web_rendered_index is defined
  changed_when: web_rendered_index is changed
  notify:
    - Restart PHP-FPM Container
    - Restart Nginx Container

- name: Ensure index ownership inside php container
  community.docker.docker_container_exec:
    container: "{{ web_php_fpm_container_name }}"
    command: >
      sh -c "if [ -f {{ web_php_web_root }}/index.php ];
      then chown {{ web_container_user }}:{{ web_container_user }} {{ web_php_web_root }}/index.php; fi"
  changed_when: false

- name: Check nginx configuration
  community.docker.docker_container_exec:
    container: "{{ web_nginx_container_name }}"
    command: "nginx -t"
  register: web_nginx_test
  changed_when: false

- name: Display nginx test output
  ansible.builtin.debug:
    msg: "{{ web_nginx_test.stdout }}"
